# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Проект
BillHub — портал для поставщиков: прикрепление счетов, оформление распределительных писем (РП), цепочки согласований, отправка в заказ. OCR-распознавание счетов через OpenRouter.ai API.

**Стек:**
- Frontend: React 18 + Vite + TypeScript + Ant Design 5 + Zustand
- Backend: Supabase (Auth, Database, Storage, Edge Functions)
- OCR: OpenRouter.ai API (выбор модели в настройках портала)

## Быстрый старт
```bash
npm run dev       # Vite dev server (port 5173)
npm run build     # Production build
npm run lint      # Lint
```

## Архитектура
```
src/
├── pages/          # Страницы-роуты
├── components/     # UI-компоненты
├── hooks/          # Кастомные хуки
├── services/       # API-сервисы (Supabase клиент, OpenRouter)
├── store/          # Zustand stores
├── types/          # TypeScript типы/интерфейсы
├── utils/          # Утилиты
├── layout/         # Layout-компоненты
└── theme/          # Тема Ant Design
```

**Path aliases (vite.config.ts):**
- `@/` -> `./src`

## Ключевые сущности

**Справочники:**
- Контрагент (Counterparty) — справочник поставщиков
- Сотрудник (Employee) — справочник сотрудников
- Объект строительства (ConstructionSite) — справочник объектов
- Тип документа (DocumentType) — справочник типов документов (акты, допуски, лицензии и т.д.)
- Обязательные документы объекта (SiteRequiredDocument) — маппинг: какие документы обязательны для конкретного объекта (настраивается в администрировании)

**Документооборот:**
- Счёт (Invoice) — загруженные счета с OCR-распознаванием
- Спецификация (Specification) — строки счёта (создаются на основе OCR)
- Документ (Document) — прикреплённые документы контрагента/поставки
- Распред. письмо (DistributionLetter / РП) — документ на согласование

**Согласования:**
- Цепочка согласования (ApprovalChain) — конструктор цепочек
- Этап согласования (ApprovalStep) — шаг в цепочке
- Согласование (Approval) — факт согласования/отклонения

**Many-to-many:** суффикс `_mapping` (например, site_required_documents_mapping)

## Бизнес-логика
1. Поставщик загружает счёт -> OCR распознаёт -> создаётся спецификация
2. На основе спецификации формируется РП
3. РП проходит цепочку согласований (настраивается в конструкторе)
4. После согласования РП отправляется в заказ
5. Для каждого объекта строительства настраиваются обязательные документы — поставщик обязан их предоставить

## Администрирование
- Настройка обязательных документов для каждого объекта строительства (маппинг DocumentType <-> ConstructionSite)
- Конструктор цепочек согласований
- Управление справочниками (контрагенты, сотрудники, объекты, типы документов)
- Настройка OCR-моделей (добавление и выбор модели из списка OpenRouter)

## Интеграции
- **Supabase:** Auth (без RLS), Database (PostgreSQL), Storage (файлы счетов/документов), Edge Functions
- **OpenRouter.ai:** OCR через vision-модели, выбор модели в настройках

## Переменные окружения
- `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY` — облачный Supabase
- `VITE_OPENROUTER_API_KEY` — ключ OpenRouter.ai
- НЕ читать, НЕ искать, НЕ модифицировать файлы `.env`
- При необходимости указать какие переменные нужны, но не запрашивать значения

## Стиль кода
- **Максимум 600 строк на файл** — разбивать на компоненты
- Functional React components с хуками
- Async/await для асинхронных операций
- camelCase для переменных, PascalCase для компонентов
- **Комментарии ТОЛЬКО на русском языке**
- **Коммуникация в чате ТОЛЬКО на русском языке**
- Ant Design 5 для всех UI-компонентов
- Responsive design (desktop + mobile)

## Коммуникация
- НЕ выводить код в ответах — только описание изменений
- НЕ использовать эмодзи
- Писать лаконично
- Указывать какие файлы изменены и что перезапустить

## Ключевые принципы
- Ant Design 5 для всех UI-компонентов
- Responsive design (desktop + mobile)
- Файлы хранить ТОЛЬКО через Supabase Storage

## Работа с задачами
**ОБЯЗАТЕЛЬНО перед выполнением:**
1. Проанализировать задачу на наличие разных вариантов решения
2. Если есть варианты — описать плюсы/минусы и спросить разработчика
3. Приступать только после подтверждения

**Уточнять:** добавление полей БД, рефакторинг, архитектурные изменения, разные подходы.
**Не уточнять:** очевидные исправления, чёткие задачи, стандартный CRUD.

## База данных (Supabase)

### ЗАПРЕЩЕНО:
- RLS (Row Level Security) — авторизация через логику приложения
- Автоматическое создание/изменение таблиц без согласования
- Изменения структуры БД без согласования

### РАЗРЕШЕНО:
- Изменения только через Supabase миграции (показать -> одобрить -> запустить)

## Документация

### ЗАПРЕЩЕНО:
- MD файлы в корне проекта (кроме README.md, CLAUDE.md)
- Отчётные документы о выполненных задачах
- Файлы с инструкциями после работы

### РАЗРЕШЕНО:
- Временные файлы в `temp/` (при крайней необходимости)
- Все объяснения — в чате

## Git
- НЕ создавать коммиты
- НЕ пушить на GitHub
- Разработчик сам управляет Git
